name: Deploy Demos to Vercel

on:
  push:
    branches:
      - main
    paths:
      - 'demos/**'
      - '.github/workflows/deploy-demos.yml'
  workflow_dispatch:  # allow manual runs from the Actions tab

jobs:
  # ── Step 1: figure out which demo-* folders actually changed ──────────────
  detect:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Find changed demo folders
        id: set-matrix
        run: |
          DEPLOY_ALL=false

          # Manual trigger → redeploy everything
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            DEPLOY_ALL=true
          # First-ever push to main
          elif [ "${{ github.event.before }}" = "0000000000000000000000000000000000000000" ]; then
            DEPLOY_ALL=true
          # Workflow file itself changed → redeploy everything
          elif git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" \
               | grep -q '^\.github/workflows/deploy-demos\.yml$'; then
            DEPLOY_ALL=true
          fi

          if [ "$DEPLOY_ALL" = "true" ]; then
            DEMOS=$(find demos -maxdepth 1 -mindepth 1 -type d -name 'demo-*' -printf '%P\n' | sort)
          else
            DEMOS=$(git diff --name-only "${{ github.event.before }}" "${{ github.sha }}" \
              | grep '^demos/demo-' \
              | cut -d'/' -f2 \
              | sort -u)
          fi

          if [ -z "$DEMOS" ]; then
            echo "matrix={\"demo\":[]}" >> "$GITHUB_OUTPUT"
          else
            JSON=$(echo "$DEMOS" | jq -R . | jq -sc '{"demo": .}')
            echo "matrix=$JSON" >> "$GITHUB_OUTPUT"
          fi

  # ── Step 2: deploy each changed demo as its own Vercel project ────────────
  deploy:
    needs: detect
    if: ${{ fromJson(needs.detect.outputs.matrix).demo[0] != null }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix: ${{ fromJson(needs.detect.outputs.matrix) }}

    steps:
      - uses: actions/checkout@v4

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Install Vercel CLI
        run: npm install -g vercel@latest

      - name: Deploy ${{ matrix.demo }} → Vercel
        working-directory: demos/${{ matrix.demo }}
        env:
          VERCEL_TOKEN: ${{ secrets.VERCEL_TOKEN }}
        run: |
          # --yes auto-creates the project (named after the directory) if it
          # doesn't exist yet; captures the live URL printed by the CLI.
          DEPLOY_URL=$(vercel deploy \
            --token "$VERCEL_TOKEN" \
            --prod \
            --yes)
          echo "::notice title=Deployed::${{ matrix.demo }} → $DEPLOY_URL"
